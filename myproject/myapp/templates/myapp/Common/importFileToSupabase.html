<script>
    const SUPABASE_URL = "{{ SUPABASE_URL }}";        // Injected by Django
    const SUPABASE_KEY = "{{ SUPABASE_KEY }}";
    const SUPABASE_BUCKET = "{{SUPABASE_STORAGE_BUCKET}}";
    const folder = 'quotesImported';

    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) return alert("Please select a file first");

      const { data, error } = await client.storage
        .from(SUPABASE_BUCKET) // your Supabase bucket name
        .upload(`${folder}/${file.name}`, file, { upsert: true });

      if (error) {
        console.error("Upload error:", error.message);
        alert("❌ Upload failed: " + error.message);
      } else {
        console.log("✅ File uploaded:", data);
        alert("✅ File uploaded successfully!");
      }
    });

document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("filePickerModal");
    const openBtn = document.getElementById("openFilePicker");
    const closeBtn = document.getElementById("closeModal");
    const fileList = document.getElementById("fileList");

    // Replace this with your actual import logic
    function importFile(file) {
        alert(`Importing file: ${file.file_name}`);
        // Example: download from Supabase Storage using URL
        // window.open(file.url, "_blank");
    }

    openBtn.addEventListener("click", async () => {
        try {
            const res = await fetch("/RoosAI/exploreQuotes/"); // Django endpoint
            const data = await res.json();

            fileList.innerHTML = "";

            if (data.files.length === 0) {
                fileList.innerHTML = "<li>No files available</li>";
            } else {
                data.files.forEach(f => {
                    const li = document.createElement("li");
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.textContent = f.file_name;
                    btn.addEventListener("click", () => importFile(f));
                    li.appendChild(btn);
                    fileList.appendChild(li);
                });
            }

            modal.style.display = "flex"; // show modal
        } catch (err) {
            console.error(err);
            alert("Failed to fetch files");
        }
    });

    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });
});

async function importFile(fileRow) {
  const { bucket, file_path } = fileRow;

  // Create Supabase client (must use anon key for frontend)
  const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Download the file
  const { data, error } = await client.storage.from(bucket).download(file_path);
  if (error) {
    console.error("Download error:", error.message);
    return;
  }

  // Convert to blob or text depending on file type
  const blob = new Blob([data]);
  const text = await blob.text(); // for CSV or text files
  console.log("Imported content:", text);

  alert(`File ${fileRow.file_name} imported successfully!`);
}
</script>